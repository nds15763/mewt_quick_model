# 🐱 Mewt 调试指南

## 快速开始

1. **打开调试页面**
   ```bash
   # 启动本地服务器（如果还没有）
   python -m http.server 8000
   # 或
   npx serve
   ```

2. **访问调试控制台**
   ```
   http://localhost:8000/debug.html
   ```

3. **授权摄像头和麦克风**
   - 浏览器会请求权限，点击"允许"

---

## 📊 界面说明

### 左上角：视频预览
- 实时显示摄像头画面
- 确认图像输入正常

### 右上角：状态面板

**🎯 CURRENT STATE（当前状态）**
- 状态徽章：显示四种状态之一
  - `IDLE` (灰色) - 观察中
  - `CAT_VISUAL` (蓝色) - 检测到猫的视觉
  - `CAT_AUDIO` (橙色) - 检测到猫叫声
  - `CAT_BOTH` (绿色) - 双重确认
- `Focusing` - 是否正在关注猫咪（YES/NO）
- `Response` - 系统生成的响应文本

**⏱️ WINDOW STATUS（窗口状态）**
- 进度条：显示1秒窗口的进度（0-100%）
- `Image` - 当前窗口收集的图像检测次数
- `Audio` - 当前窗口收集的音频检测次数

### 下方：调试面板

**📷 IMAGE DETECTIONS（图像检测）**
- 显示当前窗口内的所有图像分类结果
- 格式：`类别名 置信度 状态`
- ✓ 表示超过阈值（0.3）的猫相关检测
- ✗ 表示未达标或非猫检测

**🔊 AUDIO DETECTIONS（音频检测）**
- 显示当前窗口内的所有音频分类结果
- 格式：`类别名 置信度 状态`
- ✓ 表示超过阈值（0.2）的猫叫声检测
- ✗ 表示未达标或非猫叫声

**💾 LRU CACHE（缓存监控）**
- `Size` - 当前缓存大小/最大容量（20）
- `Recent 10` - 最近10次检测中有多少次是猫
- 列表显示最近10条缓存记录：
  - `[NEW]` - 最新记录
  - 黄色边框 - 猫相关检测
  - 绿色边框 - 非猫检测

**📝 DECISION LOG（决策日志）**
- 实时滚动显示系统决策过程
- 每秒窗口触发时记录：
  - 当前状态判断
  - 检测结果（视觉/音频）
  - LRU信任机制决策
  - 最终关注状态

---

## 🔍 如何验证系统正确性

### 1. 测试图像检测

**测试步骤**：
1. 将摄像头对准一张猫的图片或真猫
2. 观察 **IMAGE DETECTIONS** 面板
3. 验证：
   - 应该看到 `cat` 或相关类别出现
   - 置信度应该 > 0.3
   - 标记为 ✓

**预期结果**：
- 状态变为 `CAT_VISUAL` 或 `CAT_BOTH`
- `Focusing` 变为 `YES ✓`
- LRU 缓存开始记录猫的检测

### 2. 测试音频检测

**测试步骤**：
1. 播放猫叫声音频（或让真猫叫）
2. 观察 **AUDIO DETECTIONS** 面板
3. 验证：
   - 应该看到 `cat`, `meow`, 或相关类别
   - 置信度应该 > 0.2
   - 标记为 ✓

**预期结果**：
- 状态变为 `CAT_AUDIO` 或 `CAT_BOTH`
- 日志显示 `Audio=✓`

### 3. 测试双重检测

**测试步骤**：
1. 同时提供猫的图像和声音
2. 观察状态徽章

**预期结果**：
- 状态变为 `CAT_BOTH` (绿色)
- 响应文本："哦！是个小猫"

### 4. 测试 LRU 信任机制

**测试步骤**：
1. 先让系统检测到猫（持续5秒）
2. 观察 LRU 缓存填充（应该有多条猫记录）
3. 移开猫（状态变为 IDLE）
4. 观察日志

**预期结果**：
- 虽然当前状态是 `IDLE`
- 但 `Focusing` 仍然是 `YES ✓`
- 日志显示：`LRU Trust: X/10 cats → Maintain focus`
- 这证明信任机制在工作！

### 5. 测试时间窗口聚合

**观察要点**：
1. 进度条每秒从 0% 到 100%
2. 每次到达 100% 时：
   - 窗口数据被处理
   - LRU 缓存更新
   - 日志记录新条目
   - 计数器重置

**验证同类别去重**：
- 在1秒内多次检测到同一类别
- IMAGE/AUDIO 面板应只显示该类别一次
- 保留的是最高置信度

---

## 🐛 常见问题排查

### 问题1：摄像头无法访问
- 检查浏览器权限设置
- 确保使用 HTTPS 或 localhost
- 尝试刷新页面重新授权

### 问题2：没有检测结果
- 确认模型加载完成（loading 消失）
- 检查浏览器控制台是否有错误
- 尝试对准明确的猫图片

### 问题3：LRU 缓存不更新
- 确认图像检测有结果
- 等待窗口触发（进度条到 100%）
- 检查日志是否有 "Window triggered" 记录

### 问题4：状态一直是 IDLE
- 检查检测阈值（图像0.3，音频0.2）
- 尝试提高图像质量或音量
- 查看检测面板的置信度分数

---

## 📈 性能监控

### 关键指标

1. **检测频率**
   - 图像：~30fps（受浏览器性能影响）
   - 音频：连续流处理

2. **窗口处理**
   - 每秒触发一次
   - 日志应该每秒新增4条记录

3. **LRU 容量**
   - 最大 20 条记录
   - 超出后自动淘汰最旧记录

4. **内存使用**
   - 日志限制 100 条
   - 显示最近 30 条
   - 自动清理旧数据

---

## 🎨 调试技巧

### 技巧1：观察状态转换
记录不同场景下的状态变化：
```
无输入 → IDLE
出现猫 → CAT_VISUAL
播放声音 → CAT_AUDIO
同时出现 → CAT_BOTH
猫离开 → IDLE (但 Focusing 可能仍为 YES)
```

### 技巧2：分析置信度变化
- 观察同一对象在不同角度/光照下的置信度
- 找到最佳检测条件
- 调整阈值（需修改 mewt.js 配置）

### 技巧3：验证信任机制时机
- 当 LRU 中有 3-7 条猫记录时
- 移开猫观察状态
- 等待 10 秒，观察何时 Focusing 变为 NO

### 技巧4：使用浏览器开发者工具
```javascript
// 在控制台输入，访问 mewt 实例
console.log(mewt.getFullContext());
console.log(mewt.getCacheInfo());
```

---

## 🔧 自定义配置

如需调整检测参数，修改 `mewt.js` 中的配置：

```javascript
this.config = {
  CAT_DETECTION_THRESHOLD: 0.3,  // 图像阈值
  CAT_SOUND_THRESHOLD: 0.2,      // 音频阈值
  WINDOW_INTERVAL: 1000,         // 窗口间隔（毫秒）
  LRU_TRUST_COUNT: 10           // 信任检查数量
};
```

---

## 📝 预期行为总结

| 场景 | 图像检测 | 音频检测 | 状态 | Focusing | 响应文本 |
|------|---------|---------|------|----------|---------|
| 无输入 | ✗ | ✗ | IDLE | 取决于历史 | 观察中... |
| 看到猫 | ✓ | ✗ | CAT_VISUAL | YES | 那里有只小猫 |
| 听到猫叫 | ✗ | ✓ | CAT_AUDIO | YES | 诶？我好像听到小猫叫了 |
| 又看又听 | ✓ | ✓ | CAT_BOTH | YES | 哦！是个小猫 |
| 猫刚离开 | ✗ | ✗ | IDLE | YES (信任) | 观察中... |
| 猫离开久了 | ✗ | ✗ | IDLE | NO | 观察中... |

---

## ✅ 调试检查清单

使用此调试页面时，按顺序验证：

- [ ] 页面加载，模型初始化成功
- [ ] 摄像头和麦克风授权成功
- [ ] 视频预览正常显示
- [ ] 图像检测面板有数据更新
- [ ] 音频检测面板有数据更新
- [ ] 窗口进度条正常运行（0-100%循环）
- [ ] LRU 缓存随检测更新
- [ ] 决策日志每秒记录
- [ ] 四种状态可以正常切换
- [ ] 信任机制在 IDLE 状态下工作

全部 ✓ = 系统运行正常！
