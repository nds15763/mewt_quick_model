<!DOCTYPE html>
<!--
  Deep Mewt通讯测试页面
  
  功能：
  1. 模拟RN发送deepmewt状态切换消息
  2. 测试WebView接收和处理消息的功能
  3. 验证状态管理和响应机制
  
  测试场景：
  - 启用Deep Mewt模式
  - 禁用Deep Mewt模式
  - 错误消息处理
  - 状态确认响应
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Mewt通讯测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .test-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    
    .test-button:hover {
      background: #0056b3;
    }
    
    .test-button.danger {
      background: #dc3545;
    }
    
    .test-button.danger:hover {
      background: #c82333;
    }
    
    .status-display {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
    }
    
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
    
    .log-time {
      color: #666;
      font-size: 12px;
    }
    
    .status-on {
      color: #28a745;
      font-weight: bold;
    }
    
    .status-off {
      color: #dc3545;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>🧠 Deep Mewt通讯测试</h1>
  
  <div class="test-panel">
    <h3>📱 模拟RN消息发送</h3>
    <p>点击按钮模拟React Native发送deepmewt状态切换消息：</p>
    
    <button class="test-button" onclick="sendDeepMewtToggle(true)">
      🟢 启用Deep Mewt模式
    </button>
    
    <button class="test-button" onclick="sendDeepMewtToggle(false)">
      🔴 禁用Deep Mewt模式
    </button>
    
    <button class="test-button danger" onclick="sendInvalidMessage()">
      ❌ 发送无效消息（测试错误处理）
    </button>
  </div>
  
  <div class="test-panel">
    <h3>📊 当前状态</h3>
    <div class="status-display">
      <div>Deep Mewt状态: <span id="status-display" class="status-off">OFF</span></div>
      <div>最后更新: <span id="last-update">未更新</span></div>
    </div>
  </div>
  
  <div class="test-panel">
    <h3>📝 消息日志</h3>
    <div id="message-log" class="status-display">
      <div class="log-entry">等待消息...</div>
    </div>
  </div>
  
  <div class="test-panel">
    <h3>🔄 RN响应消息</h3>
    <div id="rn-response-log" class="status-display">
      <div class="log-entry">等待响应...</div>
    </div>
  </div>

  <script>
    // 初始化Deep Mewt状态
    window.DEEP_MEWT_ENABLED = false;
    
    // 消息日志
    const messageLog = [];
    const rnResponseLog = [];
    
    // 模拟sendToRN函数（记录响应消息）
    window.sendToRN = function(text, source, state, metadata = {}) {
      const message = {
        type: 'text_update',
        text,
        source,
        state,
        timestamp: Date.now(),
        metadata
      };
      
      addRNResponseLog(`[响应] ${text}`, JSON.stringify(metadata, null, 2));
      console.log('[→ RN] 模拟发送:', message);
    };
    
    // 添加消息监听器（与实际项目相同的逻辑）
    window.addEventListener('message', function(event) {
      try {
        const data = JSON.parse(event.data);
        addMessageLog(`[收到] ${data.type}`, JSON.stringify(data, null, 2));
        
        if (data.type === 'deep_mewt_toggle') {
          // 更新Deep Mewt状态
          const previousState = window.DEEP_MEWT_ENABLED;
          window.DEEP_MEWT_ENABLED = data.enabled;
          
          addMessageLog(`[状态] Deep Mewt: ${data.enabled ? 'ON' : 'OFF'} (之前: ${previousState ? 'ON' : 'OFF'})`);
          
          // 更新显示
          updateStatusDisplay();
          
          // 状态变化时的处理逻辑
          if (data.enabled !== previousState) {
            addMessageLog('[处理] Deep Mewt状态已切换，准备启用增强检测模式');
          }
          
          // 向RN确认状态更新
          sendToRN(
            `Deep Mewt模式已${data.enabled ? '启用' : '关闭'}`, 
            'system', 
            'idle', 
            { 
              deepMewtEnabled: window.DEEP_MEWT_ENABLED,
              statusUpdate: true 
            }
          );
        }
      } catch (e) {
        addMessageLog('[错误] 消息解析失败', e.message);
      }
    });
    
    // 发送Deep Mewt切换消息
    function sendDeepMewtToggle(enabled) {
      const message = {
        type: 'deep_mewt_toggle',
        enabled: enabled,
        timestamp: Date.now()
      };
      
      addMessageLog(`[发送] deep_mewt_toggle`, `enabled: ${enabled}`);
      
      // 模拟RN发送消息到WebView
      window.postMessage(JSON.stringify(message), '*');
    }
    
    // 发送无效消息（测试错误处理）
    function sendInvalidMessage() {
      const invalidMessage = "这不是一个有效的JSON";
      addMessageLog(`[发送] 无效消息`, invalidMessage);
      window.postMessage(invalidMessage, '*');
    }
    
    // 添加消息日志
    function addMessageLog(title, content = '') {
      const time = new Date().toLocaleTimeString();
      messageLog.push({ time, title, content });
      
      if (messageLog.length > 20) messageLog.shift();
      
      const logDiv = document.getElementById('message-log');
      logDiv.innerHTML = messageLog.slice(-10).reverse()
        .map(entry => `
          <div class="log-entry">
            <span class="log-time">[${entry.time}]</span> ${entry.title}
            ${entry.content ? `<br><small style="color: #666;">${entry.content}</small>` : ''}
          </div>
        `).join('');
    }
    
    // 添加RN响应日志
    function addRNResponseLog(title, content = '') {
      const time = new Date().toLocaleTimeString();
      rnResponseLog.push({ time, title, content });
      
      if (rnResponseLog.length > 20) rnResponseLog.shift();
      
      const logDiv = document.getElementById('rn-response-log');
      logDiv.innerHTML = rnResponseLog.slice(-10).reverse()
        .map(entry => `
          <div class="log-entry">
            <span class="log-time">[${entry.time}]</span> ${entry.title}
            ${entry.content ? `<br><small style="color: #666;">${entry.content}</small>` : ''}
          </div>
        `).join('');
    }
    
    // 更新状态显示
    function updateStatusDisplay() {
      const statusElement = document.getElementById('status-display');
      const updateElement = document.getElementById('last-update');
      
      statusElement.textContent = window.DEEP_MEWT_ENABLED ? 'ON' : 'OFF';
      statusElement.className = window.DEEP_MEWT_ENABLED ? 'status-on' : 'status-off';
      updateElement.textContent = new Date().toLocaleTimeString();
    }
    
    // 初始化显示
    updateStatusDisplay();
    addMessageLog('[初始化] Deep Mewt通讯测试页面已加载');
  </script>
</body>
</html>